name: Flutter CRM CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Build and Test Job
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test
      
    - name: Build APK
      run: flutter build apk --release
      
    - name: Build Web
      run: flutter build web --release
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: build/app/outputs/flutter-apk/app-release.apk
        
    - name: Upload Web build artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web/

  # Code Quality Job
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run linter
      run: flutter analyze --no-fatal-infos
      
    - name: Check code formatting
      run: dart format --set-exit-if-changed .

  # Security Scan Job
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan
      uses: github/codeql-action/init@v3
      with:
        languages: dart
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # Deploy to Supabase (if on main branch)
  deploy:
    needs: [build-and-test, code-quality, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    - name: Build for production
      run: flutter build web --release
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy to Supabase
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      run: |
        echo "Deploying to Supabase..."
        
        # Check if secrets are available
        if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
          echo "Warning: SUPABASE_ACCESS_TOKEN not set. Skipping Supabase deployment."
          echo "Please add SUPABASE_ACCESS_TOKEN to your repository secrets."
          exit 0
        fi
        
        # Link to your Supabase project (if not already linked)
        # supabase link --project-ref your-project-ref
        
        # Push database migrations
        # supabase db push
        
        # Deploy Edge Functions (if any)
        # supabase functions deploy
        
        # Deploy any custom configurations
        # supabase config push
        
        echo "Supabase deployment completed successfully!" 