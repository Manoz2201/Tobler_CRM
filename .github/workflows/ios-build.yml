name: iOS Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Clean and regenerate iOS project
      run: |
        flutter clean
        flutter pub get
        cd ios
        rm -rf Pods Podfile.lock
        pod install --repo-update
        cd ..
        
    - name: Build iOS (Debug)
      run: flutter build ios --debug --no-codesign
      
    - name: Build iOS (Release)
      run: flutter build ios --release --no-codesign
      
    - name: Upload iOS Debug Build
      uses: actions/upload-artifact@v4
      with:
        name: ios-debug-build
        path: build/ios/iphoneos/
        retention-days: 7
        
    - name: Upload iOS Release Build
      uses: actions/upload-artifact@v4
      with:
        name: ios-release-build
        path: build/ios/iphoneos/
        retention-days: 7
        
    - name: Create IPA (if signing is configured)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        # This step requires proper iOS signing setup
        # You would need to add iOS signing certificates and provisioning profiles
        # as secrets to your repository
        echo "IPA creation requires iOS signing setup"
        # flutter build ipa --release
      
    - name: Upload IPA (if created)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build/ios/ipa/
        retention-days: 30 